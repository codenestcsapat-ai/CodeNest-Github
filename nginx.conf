# =============================================
# CodeNest - Nginx Configuration
# Performance Optimization & Caching
# =============================================
# Instructions:
# Add this configuration to your server block in nginx.conf
# or include it as a separate file

# Main server block
server {
    listen 80;
    listen [::]:80;
    server_name codenest.hu www.codenest.hu;
    
    # Root directory
    root /var/www/html;
    index index.html index.htm;
    
    # =============================================
    # GZIP Compression
    # =============================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml
        image/x-icon;
    gzip_disable "msie6";
    
    # =============================================
    # Browser Caching for Static Assets
    # =============================================
    
    # HTML - No caching
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }
    
    # WebP images in /public_optimized/ - Long-term caching (1 year, immutable)
    location /public_optimized/ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }
    
    # CSS and JavaScript - 1 year caching
    location ~* \.(css|js)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        access_log off;
    }
    
    # Images - 1 year caching
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        access_log off;
    }
    
    # Fonts - 1 year caching
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        add_header Access-Control-Allow-Origin "*";
        access_log off;
    }
    
    # JSON and XML - No caching
    location ~* \.(json|xml)$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # =============================================
    # Security Headers
    # =============================================
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # =============================================
    # WebP Support - Serve WebP if available
    # =============================================
    location ~ \.(jpe?g|png)$ {
        add_header Vary Accept;
        
        # Try to serve WebP version if browser supports it
        if ($http_accept ~* "image/webp") {
            rewrite ^(.*)\.jpe?g$ $1.webp break;
            rewrite ^(.*)\.png$ $1.webp break;
        }
        
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
        access_log off;
    }
    
    # =============================================
    # Main Location Block
    # =============================================
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # =============================================
    # Deny access to hidden files
    # =============================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # =============================================
    # Logging
    # =============================================
    access_log /var/log/nginx/codenest_access.log;
    error_log /var/log/nginx/codenest_error.log;
}

# =============================================
# HTTP/2 and SSL Configuration (Recommended)
# =============================================
# Uncomment and configure for HTTPS:
#
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name codenest.hu www.codenest.hu;
#     
#     ssl_certificate /path/to/ssl/certificate.crt;
#     ssl_certificate_key /path/to/ssl/private.key;
#     
#     # SSL Configuration
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     
#     # Include all settings from above server block
#     # ...
# }
#
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     listen [::]:80;
#     server_name codenest.hu www.codenest.hu;
#     return 301 https://$server_name$request_uri;
# }
